---
title: "Flagged Sample Report"
author: "WQ-Review"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
runtime: shiny
---

```{r,echo=FALSE}
require(WQReview)
require(plyr)
###Pull data
qw.data <- suppressWarnings(readNWISodbc(DSN=DSN,
                                 env.db = env.db,
                                 qa.db=qa.db,
                                 STAIDS=STAIDS,
                                 dl.parms=dl.parms,
                                 parm.group.check=parm.group.check,
                                 begin.date=begin.date,
                                 end.date=end.date)
)
                             
###Run report generation on qw.data 
reports <- NULL

        ######################################
        #######Run report generation##########
        ######################################
        
        tryCatch({
                ###Run ion balance function
                ionBalanceOut <- suppressWarnings(ionBalance(qw.data = qw.data,wide=TRUE))
                chargebalance.table <- ionBalanceOut$chargebalance.table
                reports$BalanceDataTable <- ionBalanceOut$BalanceDataTable
                reports$balanceTable <- ionBalanceOut$chargebalance.table
                
                ###Check that a balance was calculated
                if(nrow(chargebalance.table) > 0)
                {
                        
                        ###Join charge balance table to plot table
                        chargebalance.table <- chargebalance.table[c("RECORD_NO","sum_cat","sum_an","perc.diff","complete.chem")]
                        qw.data$PlotTable <- join(qw.data$PlotTable,chargebalance.table[!duplicated(chargebalance.table$RECORD_NO), ],by="RECORD_NO")
                        
                        
                } else {}
                
        }, warning = function(w) {
                ###Run ion balance function
                ionBalanceOut <- ionBalance(qw.data = qw.data,wide=TRUE)
                chargebalance.table <- ionBalanceOut$chargebalance.table
                reports$BalanceDataTable <- ionBalanceOut$BalanceDataTable
                reports$balanceTable <- ionBalanceOut$chargebalance.table
                
                ###Check that a balance was calculated
                if(nrow(chargebalance.table) > 0)
                {
                        
                        ###Join charge balance table to plot table
                        chargebalance.table <- chargebalance.table[c("RECORD_NO","sum_cat","sum_an","perc.diff","complete.chem")]
                        qw.data$PlotTable <- join(qw.data$PlotTable,chargebalance.table[!duplicated(chargebalance.table$RECORD_NO), ],by="RECORD_NO")
                        
                        
                } else {}
                warning(w,"This caused a warning DO NOT REPORT UNLESS YOU NOTICE A PROBLEM WITH PERFORMANCE")
        }, error = function(e) {
                errors <- print("Error with charge balance. please report this on the github issues page")
                        
        })
        
        tryCatch({
                
                ###Run repTabler
                reports$repTable <- suppressWarnings(repTabler(qw.data))
        
        }, warning = function(w) {
                
                ###Run repTabler
                reports$repTable <- repTabler(qw.data)
                warning(w,"This caused a warning DO NOT REPORT UNLESS YOU NOTICE A PROBLEM WITH PERFORMANCE")
        }, error = function(e) {
                errors <- print("Error with replicate table. please report this on the github issues page")
        })
        

        tryCatch({
                ###Run wholevPart
                reports$wholevpartTable <- suppressWarnings(wholevPart(qw.data))
                
        }, warning = function(w) {
                ###Run wholevPart
                reports$wholevpartTable <- wholevPart(qw.data)
                warning(w,"This caused a warning DO NOT REPORT UNLESS YOU NOTICE A PROBLEM WITH PERFORMANCE")
        }, error = function(e) {
                errors <- print("Error with whole vs part table. please report this on the github issues page")
                
        })
        

        ###Generate chem flag summary
        tryCatch({
                reports$chemFlagTable <- suppressWarnings(chemCheck(qw.data))
        },
        warning = function(w) {
                reports$chemFlagTable <- suppressWarnings(chemCheck(qw.data))
        },
        error = function(e) {
                errors <- print("Error with auto sample flagging, please report this on the github issues page")
        })
        
        ###Generate chem flag summary
        tryCatch({
                reports$pestFlagTable <- suppressWarnings(pestCheck(qw.data))
        },
        warning = function(w) {
                reports$pestFlagTable <- suppressWarnings(pestCheck(qw.data))
        },
        error = function(e) {
                errors <- print("Error with auto sample flagging, please report this on the github issues page")
        })
        
        ###Generate sample flag summary
        tryCatch({
                reports$sampleFlagTable <- suppressWarnings(flagSummary(qw.data))
                ###Need to reset row names
                rownames(reports$sampleFlagTable) <- seq(from = 1, to = nrow(reports$sampleFlagTable))
                },
                warning = function(w) {
                        reports$sampleFlagTable <- suppressWarnings(flagSummary(qw.data))
                        ###Need to reset row names
                        rownames(reports$sampleFlagTable) <- seq(from = 1, to = nrow(reports$sampleFlagTable))
                        
                        },
                error = function(e) {
                        errors <- print("Error with auto sample flagging, please report this on the github issues page")
                        })
        
        ###Generate result flags
        tryCatch({
                reports$resultFlagTable <- suppressWarnings(historicCheck(qw.data,returnAll=FALSE))
                ###Need to reset row names
                rownames(reports$resultFlagTable) <- seq(from = 1, to = nrow(reports$resultFlagTable))
                },
                warning = function(w) {
                
                        reports$resultFlagTable <- suppressWarnings(historicCheck(qw.data,returnAll=FALSE)) 
                        ###Need to reset row names
                        rownames(reports$resultFlagTable) <- seq(from = 1, to = nrow(reports$resultFlagTable))
                        },
                error = function(e) {
                        print("Error with auto result flagging, please report this on the github issues page")
                })
        
```
        

#Flagged tables
##Sample-level flags
```{r,echo=FALSE}
require(DT)
############################
###sampleFlagTable
############################


###Render the table
datatable(
        reports$sampleFlagTable,
        #extensions = list(FixedColumns = list(leftColumns = 5)),
        options = list(
                scrollX=TRUE,
                autoWidth=TRUE)
)
```

##Result-level flags

```{r,echo=FALSE}
require(DT)

############################
###resultFlagTable
############################

###Render the table

datatable(
        reports$resultFlagTable,
        extensions = list(FixedColumns = list(leftColumns = 5)),
        options = list(
                scrollX=TRUE,
                autoWidth=TRUE)
)


```

```{r, echo=FALSE, results='asis',message=FALSE,warning=FALSE}
require(gridExtra)
records <- unique(na.omit(reports$sampleFlagTable[c("SITE_NO","STATION_NM")]))
for(i in 1:nrow(records))
{
        cat("#",records$STATION_NM[i],"\n")
        if(all(!is.na(reports$sampleFlagTable$BadCB_30.21[which(reports$sampleFlagTable$RECORD_NO == records$RECORD_NO[i])])))
        {
        cat("# Chargbalance plots \n")
        cbPlot <- qwcbPlot(qw.data,
                           site.selection = records$SITE_NO[i],
                           highlightrecords = unique(reports$sampleFlagTable$RECORD_NO),
                           print=FALSE)
        scSumPlot <- qwscSumPlot(qw.data,
                           site.selection = records$SITE_NO[i],
                           highlightrecords = unique(reports$sampleFlagTable$RECORD_NO),
                           print=FALSE)
        grid.arrange(cbPlot,scSumPlot)
        }else{}
}


