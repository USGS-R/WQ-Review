---
title: "`r siteName`"
author: "WQ-Review"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
```{r setup, include=FALSE}
###Load libraries and setup options

require(WQReview)
require(plyr)
require(knitr)
opts_chunk$set(dev = 'png',out.width='1024px',out.height='750px',dpi=60)
```

```{r,echo=FALSE}
###Load up the data
load("data.rda")
###Subset to site
qw.data$PlotTable <- subset(qw.data$PlotTable,SITE_NO == site)
reports$chemFlagTable <- subset(reports$chemFlagTable, SITE_NO == site)
reports$pestFlagTable <- subset(reports$pestFlagTable, SITE_NO == site)   
reports$resultFlagTable <- subset(reports$resultFlagTable, SITE_NO == site) 
        
```
        

```{r, echo=FALSE, results='asis',message=FALSE,warning=FALSE}
require(gridExtra)

        ###Run charge balance checks
        if(all(!is.na(reports$chemFlagTable$BadCB_30.21[which(reports$chemFlagTable$SITE_NO == site)])))
        {
        cat("## Chargbalance flag plots","\n")
        cbPlot <- qwcbPlot(qw.data,
                           site.selection = site,
                           highlightrecords = unique(reports$chemFlagTable$RECORD_NO[which(!is.na(reports$chemFlagTable$BadCB_30.21))]),
                           print=FALSE)
        scSumPlot <- qwscSumPlot(qw.data,
                           site.selection = site,
                           highlightrecords = unique(reports$chemFlagTable$RECORD_NO[which(!is.na(reports$chemFlagTable$BadCB_30.21))]),
                           print=FALSE)
        grid.arrange(cbPlot,scSumPlot,nrow=1,ncol=2)
        cat("\n\n")

        }else{}
        
        ###Run result checks
        cat("## Result flag plots","\n")
        siteData <- subset(qw.data$PlotTable,SITE_NO == site &
                                   RESULT_CR > Sys.time() - 60*60*24*365*3)
        parms <- unique(siteData[c("PARM_CD","PARM_NM","PARM_SEQ_GRP_CD")])
        parms <- subset(parms, PARM_SEQ_GRP_CD %in% c("INN","INM","NUT","SED") | PARM_CD %in% c("00095","00061","00400","00010"))
        
        for(j in 1:nrow(parms))
                {
                
                cat("###",parms$PARM_CD[j],parms$PARM_NM[j],"\n")
                
                tsPlot <- qwtsPlot(qw.data = qw.data,
                   site.selection = site,
                   plotparm = parms$PARM_CD[j],
                   highlightrecords = unique(reports$resultFlagTable$RECORD_NO[which(reports$resultFlagTable$PARM_CD == parms$PARM_CD[j])]),
                   print = FALSE)
                
                seasonalPlot <- qwseasonalPlot(qw.data,
                               site.selection = site,
                               plotparm = parms$PARM_CD[j],
                               highlightrecords = unique(reports$resultFlagTable$RECORD_NO[which(reports$resultFlagTable$PARM_CD == parms$PARM_CD[j])]),
                               print = FALSE)
                
                pqPlot <- qwparmParmPlot(qw.data,
                         site.selection = site,
                         yparm = parms$PARM_CD[j],
                         xparm = "00061",
                         highlightrecords = unique(reports$resultFlagTable$RECORD_NO[which(reports$resultFlagTable$PARM_CD == parms$PARM_CD[j])]),
                         print = FALSE)
                
                pSCPlot <- qwparmParmPlot(qw.data,
                          site.selection = site,
                          yparm = parms$PARM_CD[j],
                          xparm = "00095",
                          highlightrecords = unique(reports$resultFlagTable$RECORD_NO[which(reports$resultFlagTable$PARM_CD == parms$PARM_CD[j])]),
                          print = FALSE)
                
                grid.arrange(tsPlot,seasonalPlot,pqPlot,pSCPlot,nrow=2,ncol=2)
                cat("\n\n")
        }

                



        



